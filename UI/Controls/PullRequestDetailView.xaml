<UserControl x:Class="GitWave.UI.Controls.PullRequestDetailView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:vm="clr-namespace:GitWave.ViewModels"
             xmlns:controls="clr-namespace:GitWave.UI.Controls"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="600"
             d:DataContext="{d:DesignInstance Type=vm:PullRequestItemViewModel}">

    <UserControl.Resources>
        <Style x:Key="ReviewMenuItemStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="bd" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="#F3F4F6"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>
    
    <Grid Background="White">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Grid Grid.Row="0" Margin="16,16,16,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <StackPanel Grid.Column="0">
                <TextBlock FontSize="20" FontWeight="Bold">
                    <Run Text="{Binding Title, Mode=OneWay}"/>
                    <Run Text=" #"/>
                    <Run Text="{Binding Number, Mode=OneWay}"/>
                </TextBlock>

                <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                    <Border Background="{Binding StatusColor}" CornerRadius="4" Padding="6,2" Margin="0,0,8,0">
                        <TextBlock Text="{Binding Status}" Foreground="White" FontSize="12" FontWeight="SemiBold"/>
                    </Border>
                    <TextBlock VerticalAlignment="Center" Foreground="Gray">
                        <Run Text="{Binding Author, Mode=OneWay}"/>
                        <Run Text=" wants to merge commits into main"/>
                    </TextBlock>
                </StackPanel>
            </StackPanel>

            <Button Grid.Column="1" Content="Merge Pull Request"
                    Command="{Binding MergeCommand}"
                    IsEnabled="{Binding IsOpen}"
                    Background="#2da44e" Foreground="White" FontWeight="Bold" 
                    Padding="12,6" Height="32" VerticalAlignment="Top">
                <Button.Resources>
                    <Style TargetType="Border">
                        <Setter Property="CornerRadius" Value="4"/>
                    </Style>
                </Button.Resources>
            </Button>
        </Grid>

        <TabControl Grid.Row="1" BorderThickness="0,1,0,0" Background="Transparent">
            <TabItem Header="Conversation" IsSelected="True">
                <controls:ConversationView DataContext="{Binding Conversation}" />
            </TabItem>

            <TabItem Header="Commits">
                <Grid Background="#F9F9F9">
                    <Border BorderBrush="#DDDDDD" BorderThickness="0" Background="White" Padding="0">
                        <DockPanel>
                            <TextBlock Text="Select a file to open Diff Window" DockPanel.Dock="Top" Margin="16,12" FontSize="12" Foreground="Gray" FontStyle="Italic"/>

                            <TreeView BorderThickness="0" Padding="10" FontSize="14"
                                      ItemsSource="{Binding Commits}">
                                <TreeView.Resources>
                                    <HierarchicalDataTemplate DataType="{x:Type vm:CommitNodeViewModel}" ItemsSource="{Binding Files}">
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                            <TextBlock Text="{Binding Message}" FontWeight="Bold"/>
                                            <TextBlock Text="{Binding ShaShort, StringFormat=' ({0})'}" Foreground="Gray" FontFamily="Consolas"/>
                                        </StackPanel>
                                    </HierarchicalDataTemplate>

                                    <DataTemplate DataType="{x:Type vm:FileChangeViewModel}">
                                        <StackPanel Orientation="Horizontal" Margin="5,0" PreviewMouseLeftButtonUp="OnChangedFileClick">
                                            <TextBlock FontFamily="Segoe MDL2 Assets"
                                                        VerticalAlignment="Center"
                                                        Text="{Binding IconGlyph}"
                                                        Foreground="{Binding IconColor}"
                                                        FontSize="12"
                                                        FontWeight="ExtraBold"
                                                        Width="20"/>
                                            <TextBlock Text="{Binding FileName}"
                                                        Foreground="{Binding IconColor}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </TreeView.Resources>
                            </TreeView>
                        </DockPanel>
                    </Border>
                </Grid>
            </TabItem>
        </TabControl>

        <Border Grid.Row="2" BorderBrush="#E1E4E8" BorderThickness="0,1,0,0" Background="#F6F8FA" Padding="16">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Add a comment" FontWeight="SemiBold" FontSize="12" Foreground="#24292e" Margin="0,0,0,8"/>

                <TextBox Grid.Row="1" 
                         Height="70" 
                         TextWrapping="Wrap" 
                         AcceptsReturn="True" 
                         VerticalScrollBarVisibility="Auto"
                         Padding="8"
                         BorderBrush="#D1D5DA"
                         Background="White"
                         VerticalContentAlignment="Top"
                         FontSize="13"
                         Text="{Binding CommentText, UpdateSourceTrigger=PropertyChanged}">
                    <TextBox.Resources>
                        <Style TargetType="Border">
                            <Setter Property="CornerRadius" Value="4"/>
                        </Style>
                    </TextBox.Resources>
                </TextBox>

                <Grid Grid.Row="2" Margin="0,12,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <Button Grid.Column="0" 
                        Content="Close Pull Request" 
                        Command="{Binding ClosePrCommand}"
                        Background="Transparent" 
                        Foreground="#CB2431" 
                        FontWeight="SemiBold" 
                        BorderThickness="1" 
                        BorderBrush="#D1D5DA"
                        Padding="12,6" 
                        Cursor="Hand">
                        <Button.Resources>
                            <Style TargetType="Border">
                                <Setter Property="CornerRadius" Value="4"/>
                            </Style>
                        </Button.Resources>
                    </Button>

                    <StackPanel Grid.Column="2" Orientation="Horizontal">
                        <ToggleButton x:Name="DropdownToggle"
                            Grid.Column="0"
                            Background="#2da44e" 
                            Foreground="White" 
                            FontWeight="Bold" 
                            Padding="16,6" 
                            BorderThickness="0"
                            Cursor="Hand">
                            <TextBlock Text="Review  ▼"/>
                            <ToggleButton.Resources>
                                <Style TargetType="Border">
                                    <Setter Property="CornerRadius" Value="4"/>
                                </Style>
                            </ToggleButton.Resources>
                        </ToggleButton>

                        <Popup PlacementTarget="{Binding ElementName=DropdownToggle}"
                                Placement="Bottom"
                                AllowsTransparency="True"
                                IsOpen="{Binding IsChecked, ElementName=DropdownToggle}"
                                StaysOpen="False">
                            <Border Background="White" BorderBrush="#D1D5DA" BorderThickness="1" CornerRadius="6">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="10" ShadowDepth="2" Direction="270" Opacity="0.15"/>
                                </Border.Effect>
                                <StackPanel>
                                    <Button Content="Comment"
                                            Style="{StaticResource ReviewMenuItemStyle}"
                                            Command="{Binding CommentCommand}"
                                            CommandParameter="Comment"/>
                                    <Button Content="Approve"
                                            Style="{StaticResource ReviewMenuItemStyle}"
                                            Command="{Binding ApproveCommand}"
                                            CommandParameter="Approve"/>
                                    <Button Content="Request Changes"
                                            Style="{StaticResource ReviewMenuItemStyle}"
                                            Command="{Binding RequestChangesCommand}"
                                            CommandParameter="RequestChanges"/>
                                </StackPanel>
                            </Border>
                        </Popup>
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</UserControl>